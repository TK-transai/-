```mermaid
flowchart TD

  %% ノード定義
  subgraph " "
    direction TB
    A_Start((顧客からの<br/>見積依頼))
  end

  subgraph "システム＆担当者の動き"
    direction TB

    B_Reception["【1】依頼受付＆AIによる内容正規化<br/><br/>・メール/FAX/Webから自動取り込み<br/>・AIが型番/数量/納期などをデータ化<br/>・新規/休眠顧客を自動検知"]

    C_Check1{"内容に問題あり？<br/>(AI信頼度 低 / 新規・休眠)"}

    D_ManualCheck1["【要確認】<br/>担当者が内容を補正・確認"]

    E_StockCheck["【2】社内在庫確認<br/><br/>・基幹システムの在庫CSVと照合"]

    F_StockDecision{"在庫あり？<br/>(依頼数を満たすか)"}

    subgraph "A) 社内在庫引当ルート"
      direction TB
      G_ProfitCheck{"利益率に問題あり？"}
      H_ManualCheck2["【要確認】<br/>担当者が利益率を確認・判断"]
      I_ReadyForQuote1["社内在庫情報で<br/>見積準備完了"]
    end

    subgraph "B) 取り寄せルート"
      direction TB
      J_SupplierSelect["【3】仕入先を自動選定"]
      K_SupplierActionDecision{"Webサイトで確認可能？"}
      L_RPA["RPA<br/>仕入先Webサイトを自動確認<br/>(在庫/価格/売り止め)"]
      M_MailFax["Mail/FAX<br/>見積依頼を自動生成・送信"]
      N_GetResponse["【4】仕入先からの回答を自動取り込み"]
      O_Check2{"回答に問題あり？<br/>(紐付け失敗/ファイル開封エラー)"}
      P_ManualCheck3["【要確認】<br/>担当者が回答を手動で紐付け/開封"]
      Q_ReadyForQuote2["取り寄せ情報で<br/>見積準備完了"]
    end

    R_FinalCreate["【5】顧客向け見積書を自動生成"]
    S_ManualCheck4["【要確認（最終）】<br/>担当者が見積内容を承認"]
    T_Submit["【6】顧客へ見積書を提出"]
  end

  %% クラス定義（全て黒文字に統一）
  classDef startNode fill:#D6EAF8,stroke:#3498DB,stroke-width:2px,color:#000000
  classDef endNode   fill:#D5F5E3,stroke:#2ECC71,stroke-width:2px,color:#000000

  classDef question fill:#FEF5E7,stroke:#F1C40F,stroke-width:3px,color:#000000
  classDef confirm  fill:#F5B7B1,stroke:#C0392B,stroke-width:3px,color:#000000
  classDef normal   fill:#FDF2E9,stroke:#D5B895,stroke-width:1.5px,color:#000000

  class A_Start startNode
  class T_Submit endNode

  class B_Reception,E_StockCheck,I_ReadyForQuote1,J_SupplierSelect,L_RPA,M_MailFax,N_GetResponse,Q_ReadyForQuote2,R_FinalCreate normal
  class C_Check1,F_StockDecision,G_ProfitCheck,K_SupplierActionDecision,O_Check2 question
  class D_ManualCheck1,H_ManualCheck2,P_ManualCheck3,S_ManualCheck4 confirm

  %% フロー
  A_Start --> B_Reception
  B_Reception --> C_Check1

  C_Check1 -- はい --> D_ManualCheck1
  D_ManualCheck1 --> E_StockCheck
  C_Check1 -- いいえ --> E_StockCheck

  E_StockCheck --> F_StockDecision

  F_StockDecision -- はい --> G_ProfitCheck
  G_ProfitCheck -- はい --> H_ManualCheck2
  H_ManualCheck2 --> I_ReadyForQuote1
  G_ProfitCheck -- いいえ --> I_ReadyForQuote1
  I_ReadyForQuote1 --> R_FinalCreate

  F_StockDecision -- いいえ --> J_SupplierSelect
  J_SupplierSelect --> K_SupplierActionDecision
  K_SupplierActionDecision -- はい --> L_RPA
  K_SupplierActionDecision -- いいえ --> M_MailFax
  L_RPA --> Q_ReadyForQuote2
  M_MailFax --> N_GetResponse
  N_GetResponse --> O_Check2
  O_Check2 -- はい --> P_ManualCheck3
  P_ManualCheck3 --> Q_ReadyForQuote2
  O_Check2 -- いいえ --> Q_ReadyForQuote2
  Q_ReadyForQuote2 --> R_FinalCreate
  R_FinalCreate --> S_ManualCheck4
  S_ManualCheck4 --> T_Submit

  %% 矢印の色付け（YES=緑 / NO=赤）
  linkStyle default stroke:#666666,stroke-width:1.5px
  linkStyle 3,7,8,14,19 stroke:#27AE60,stroke-width:2px,color:#27AE60
  linkStyle 5,10,12,15,21 stroke:#E74C3C,stroke-width:2px,color:#E74C3C
